<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>FlowerShop Admin</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --bg: #1c1c1e;
            --card: #2c2c2e;
            --text: #ffffff;
            --hint: #8e8e93;
            --accent: #3390ec;
            --green: #34c759;
            --red: #ff3b30;
            --orange: #ff9500;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        .header {
            background: var(--card);
            padding: 16px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 { font-size: 18px; font-weight: 600; }
        
        .tabs {
            display: flex;
            background: var(--card);
            padding: 8px;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .tab {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: var(--hint);
            font-size: 14px;
            cursor: pointer;
        }
        
        .tab.active {
            background: var(--accent);
            color: white;
        }
        
        .content { padding: 0 16px; }
        
        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            padding: 8px;
            background: var(--card);
            border-radius: 12px;
        }
        .toolbar-btn {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .toolbar-btn.active {
            background: var(--accent);
            color: white;
        }
        .toolbar-btn.danger {
            background: var(--red);
            color: white;
        }
        
        /* Products List */
        .product-card {
            background: var(--card);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            display: flex;
            gap: 12px;
            align-items: center;
            transition: all 0.2s;
        }
        
        .product-card.selected {
            background: rgba(51, 144, 236, 0.2);
            box-shadow: inset 0 0 0 2px var(--accent);
        }
        
        .product-checkbox {
            width: 24px;
            height: 24px;
            min-width: 24px;
            border: 2px solid var(--hint);
            border-radius: 6px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .product-checkbox.checked {
            background: var(--accent);
            border-color: var(--accent);
        }
        .product-checkbox.checked::after {
            content: '‚úì';
            color: white;
            font-weight: bold;
            font-size: 14px;
        }
        .select-mode .product-checkbox {
            display: flex;
        }
        
        .product-img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--bg);
        }
        
        .product-info { flex: 1; min-width: 0; }
        .product-name { font-weight: 600; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .product-price { color: var(--green); font-weight: 500; }
        .product-status { font-size: 12px; color: var(--hint); }
        
        .product-actions { display: flex; gap: 8px; }
        .select-mode .product-actions { display: none; }
        
        .btn-icon {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        .btn-edit { background: var(--accent); color: white; }
        .btn-delete { background: var(--red); color: white; }
        
        /* Bulk Actions Bar */
        .bulk-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            padding: 12px 16px;
            display: none;
            gap: 10px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
            z-index: 200;
        }
        .bulk-bar.visible { display: flex; }
        .bulk-bar button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        .bulk-bar .btn-cancel { background: var(--hint); color: white; }
        .bulk-bar .btn-delete-selected { background: var(--orange); color: white; }
        .bulk-bar .btn-delete-all { background: var(--red); color: white; }
        .bulk-bar .selected-count {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* Confirm Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
            padding: 20px;
        }
        .modal-overlay.visible { display: flex; }
        .modal {
            background: var(--card);
            border-radius: 16px;
            padding: 24px;
            max-width: 320px;
            width: 100%;
            text-align: center;
        }
        .modal-icon { font-size: 48px; margin-bottom: 16px; }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
        .modal-text { color: var(--hint); font-size: 14px; margin-bottom: 20px; }
        .modal-buttons { display: flex; gap: 10px; }
        .modal-buttons button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }
        .modal .btn-cancel { background: var(--hint); color: white; }
        .modal .btn-confirm { background: var(--red); color: white; }
        
        /* Form */
        .form-group { margin-bottom: 16px; }
        .form-label {
            display: block;
            font-size: 13px;
            color: var(--hint);
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        .form-input {
            width: 100%;
            background: var(--card);
            border: none;
            border-radius: 12px;
            padding: 14px 16px;
            font-size: 16px;
            color: var(--text);
            outline: none;
        }
        .form-input:focus { box-shadow: 0 0 0 2px var(--accent); }
        textarea.form-input { min-height: 100px; resize: vertical; }
        
        .photo-upload {
            background: var(--card);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 16px;
        }
        .photo-upload img {
            max-width: 100%;
            max-height: 150px;
            border-radius: 8px;
        }
        .photo-icon { font-size: 40px; }
        .photo-text { color: var(--hint); font-size: 14px; margin-top: 8px; }
        
        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card);
            padding: 14px 16px;
            border-radius: 12px;
        }
        
        .toggle {
            width: 51px; height: 31px;
            background: #39393d;
            border-radius: 16px;
            position: relative;
            cursor: pointer;
        }
        .toggle.on { background: var(--green); }
        .toggle::after {
            content: '';
            position: absolute;
            width: 27px; height: 27px;
            background: white;
            border-radius: 50%;
            top: 2px; left: 2px;
            transition: 0.3s;
        }
        .toggle.on::after { left: 22px; }
        
        .btn-primary {
            width: 100%;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 16px;
        }
        .btn-primary:disabled { opacity: 0.5; }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .stat-card {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        .stat-value { font-size: 28px; font-weight: 700; }
        .stat-label { color: var(--hint); font-size: 13px; margin-top: 4px; }
        
        /* Add button */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: var(--accent);
            border: none;
            border-radius: 50%;
            font-size: 28px;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--hint);
        }
        
        .empty {
            text-align: center;
            padding: 40px;
            color: var(--hint);
        }
        .empty-icon { font-size: 48px; margin-bottom: 12px; }
        
        .hidden { display: none !important; }
        
        #fileInput { display: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üå∏ FlowerShop Admin</h1>
    </div>
    
    <div class="tabs">
        <button class="tab active" onclick="showTab('products')">üì¶ –¢–æ–≤–∞—Ä—ã</button>
        <button class="tab" onclick="showTab('stats')">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
    </div>
    
    <!-- Products Tab -->
    <div id="tab-products" class="content">
        <div class="toolbar">
            <button class="toolbar-btn" id="btn-select-mode" onclick="toggleSelectMode()">
                ‚òëÔ∏è <span>–í—ã–±—Ä–∞—Ç—å</span>
            </button>
            <button class="toolbar-btn" id="btn-select-all" onclick="selectAll()" style="display:none;">
                üìã –í—Å–µ
            </button>
        </div>
        <div id="products-list"></div>
        <button class="fab" onclick="showForm()">+</button>
    </div>
    
    <!-- Stats Tab -->
    <div id="tab-stats" class="content hidden">
        <div id="stats-content"></div>
    </div>
    
    <!-- Product Form -->
    <div id="product-form" class="content hidden">
        <div class="header" style="margin: -16px -16px 16px; position: static;">
            <h1 id="form-title">‚ûï –ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</h1>
        </div>
        
        <div class="photo-upload" onclick="document.getElementById('fileInput').click()">
            <div id="photo-placeholder">
                <div class="photo-icon">üì∑</div>
                <div class="photo-text">–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</div>
            </div>
            <img id="photo-preview" class="hidden">
        </div>
        <input type="file" id="fileInput" accept="image/*" onchange="handlePhoto(event)">
        
        <div class="form-group">
            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input type="text" class="form-input" id="f-name" placeholder="–ù–µ–∂–Ω–æ—Å—Ç—å">
        </div>
        
        <div class="form-group">
            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea class="form-input" id="f-desc" placeholder="–ë—É–∫–µ—Ç –∏–∑ 15 —Ä–æ–∑–æ–≤—ã—Ö —Ä–æ–∑..."></textarea>
        </div>
        
        <div class="form-group">
            <label class="form-label">–¶–µ–Ω–∞ (‚ÇΩ)</label>
            <input type="number" class="form-input" id="f-price" placeholder="2500">
        </div>
        
        <div class="form-group">
            <div class="toggle-row">
                <span>–í –Ω–∞–ª–∏—á–∏–∏</span>
                <div class="toggle on" id="f-stock" onclick="this.classList.toggle('on')"></div>
            </div>
        </div>
        
        <button class="btn-primary" onclick="saveProduct()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn-primary" style="background: var(--hint); margin-top: 8px;" onclick="hideForm()">–û—Ç–º–µ–Ω–∞</button>
    </div>
    
    <!-- Bulk Actions Bar -->
    <div class="bulk-bar" id="bulk-bar">
        <span class="selected-count" id="selected-count">0 –≤—ã–±—Ä–∞–Ω–æ</span>
        <button class="btn-cancel" onclick="toggleSelectMode()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn-delete-selected" id="btn-delete-selected" onclick="deleteSelected()">üóë –£–¥–∞–ª–∏—Ç—å</button>
        <button class="btn-delete-all" onclick="confirmDeleteAll()">üóë –í—Å–µ</button>
    </div>
    
    <!-- Confirm Modal -->
    <div class="modal-overlay" id="modal-confirm">
        <div class="modal">
            <div class="modal-icon">‚ö†Ô∏è</div>
            <div class="modal-title" id="modal-title">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã?</div>
            <div class="modal-text" id="modal-text">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å. –í—Å–µ —Ç–æ–≤–∞—Ä—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.</div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="hideModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-confirm" id="modal-confirm-btn" onclick="executeDelete()">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();
        
        // Apply theme
        if (tg.themeParams) {
            document.body.style.setProperty('--bg', tg.themeParams.bg_color || '#1c1c1e');
            document.body.style.setProperty('--card', tg.themeParams.secondary_bg_color || '#2c2c2e');
            document.body.style.setProperty('--text', tg.themeParams.text_color || '#ffffff');
            document.body.style.setProperty('--hint', tg.themeParams.hint_color || '#8e8e93');
            document.body.style.setProperty('--accent', tg.themeParams.button_color || '#3390ec');
        }
        
        const API = 'https://drop-seo-firewire-thompson.trycloudflare.com';
        const TOKEN = 'flowershop_admin_2024';
        
        let editingId = null;
        let photoData = null;
        let selectMode = false;
        let selectedIds = new Set();
        let allProducts = [];
        let deleteAction = null; // 'selected' or 'all'
        
        // Load products on start
        loadProducts();
        
        async function loadProducts() {
            document.getElementById('products-list').innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            
            try {
                const res = await fetch(API + '/products');
                allProducts = await res.json();
                
                if (allProducts.length === 0) {
                    document.getElementById('products-list').innerHTML = `
                        <div class="empty">
                            <div class="empty-icon">üì¶</div>
                            <div>–¢–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>
                        </div>`;
                    return;
                }
                
                renderProducts();
            } catch (e) {
                document.getElementById('products-list').innerHTML = '<div class="loading">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }
        
        function renderProducts() {
            let html = '';
            for (const p of allProducts) {
                const status = p.in_stock ? '‚úÖ –í –Ω–∞–ª–∏—á–∏–∏' : '‚ùå –ù–µ—Ç';
                const hasImg = p.image_url && p.image_url.length > 10;
                const isSelected = selectedIds.has(p.id);
                html += `
                    <div class="product-card ${isSelected ? 'selected' : ''}" data-id="${p.id}" onclick="handleCardClick(${p.id}, event)">
                        <div class="product-checkbox ${isSelected ? 'checked' : ''}" data-id="${p.id}"></div>
                        <div class="product-img" style="display:flex;align-items:center;justify-content:center;font-size:30px;background:var(--bg);">
                            ${hasImg ? `<img src="${p.image_url}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;" onerror="this.parentElement.innerHTML='üå∏'">` : 'üå∏'}
                        </div>
                        <div class="product-info">
                            <div class="product-name">${p.name}</div>
                            <div class="product-price">${p.price} ‚ÇΩ</div>
                            <div class="product-status">${status}</div>
                        </div>
                        <div class="product-actions">
                            <button class="btn-icon btn-edit" onclick="editProduct(${p.id}); event.stopPropagation();">‚úèÔ∏è</button>
                            <button class="btn-icon btn-delete" onclick="deleteProduct(${p.id}, '${p.name.replace(/'/g, "\\'")}'); event.stopPropagation();">üóë</button>
                        </div>
                    </div>`;
            }
            document.getElementById('products-list').innerHTML = html;
            updateBulkBar();
        }
        
        function handleCardClick(id, event) {
            if (!selectMode) return;
            event.stopPropagation();
            toggleSelection(id);
        }
        
        function toggleSelection(id) {
            if (selectedIds.has(id)) {
                selectedIds.delete(id);
            } else {
                selectedIds.add(id);
            }
            renderProducts();
        }
        
        function toggleSelectMode() {
            selectMode = !selectMode;
            selectedIds.clear();
            
            document.getElementById('products-list').classList.toggle('select-mode', selectMode);
            document.getElementById('btn-select-mode').classList.toggle('active', selectMode);
            document.getElementById('btn-select-all').style.display = selectMode ? 'flex' : 'none';
            document.querySelector('.fab').classList.toggle('hidden', selectMode);
            
            renderProducts();
            updateBulkBar();
        }
        
        function selectAll() {
            if (selectedIds.size === allProducts.length) {
                selectedIds.clear();
            } else {
                allProducts.forEach(p => selectedIds.add(p.id));
            }
            renderProducts();
        }
        
        function updateBulkBar() {
            const bar = document.getElementById('bulk-bar');
            const count = document.getElementById('selected-count');
            const btnDelete = document.getElementById('btn-delete-selected');
            
            bar.classList.toggle('visible', selectMode);
            count.textContent = `${selectedIds.size} –≤—ã–±—Ä–∞–Ω–æ`;
            btnDelete.disabled = selectedIds.size === 0;
            btnDelete.style.opacity = selectedIds.size === 0 ? 0.5 : 1;
        }
        
        function deleteSelected() {
            if (selectedIds.size === 0) return;
            deleteAction = 'selected';
            document.getElementById('modal-title').textContent = `–£–¥–∞–ª–∏—Ç—å ${selectedIds.size} —Ç–æ–≤–∞—Ä(–æ–≤)?`;
            document.getElementById('modal-text').textContent = '–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ.';
            document.getElementById('modal-confirm').classList.add('visible');
        }
        
        function confirmDeleteAll() {
            deleteAction = 'all';
            document.getElementById('modal-title').textContent = '–£–¥–∞–ª–∏—Ç—å –í–°–ï —Ç–æ–≤–∞—Ä—ã?';
            document.getElementById('modal-text').textContent = `–í—Å–µ ${allProducts.length} —Ç–æ–≤–∞—Ä–æ–≤ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`;
            document.getElementById('modal-confirm').classList.add('visible');
        }
        
        function hideModal() {
            document.getElementById('modal-confirm').classList.remove('visible');
            deleteAction = null;
        }
        
        async function executeDelete() {
            hideModal();
            
            const idsToDelete = deleteAction === 'all' 
                ? allProducts.map(p => p.id) 
                : Array.from(selectedIds);
            
            console.log('Deleting IDs:', idsToDelete);
            document.getElementById('products-list').innerHTML = `<div class="loading">–£–¥–∞–ª–µ–Ω–∏–µ ${idsToDelete.length} —Ç–æ–≤–∞—Ä–æ–≤...</div>`;
            
            let deleted = 0;
            let errors = [];
            
            for (const id of idsToDelete) {
                try {
                    const res = await fetch(API + '/products/' + id, {
                        method: 'DELETE',
                        headers: { 'X-Auth-Token': TOKEN }
                    });
                    console.log(`Delete ${id}:`, res.status);
                    if (res.ok) {
                        deleted++;
                    } else {
                        errors.push(`${id}: ${res.status}`);
                    }
                } catch (e) {
                    console.error(`Delete ${id} error:`, e);
                    errors.push(`${id}: ${e.message}`);
                }
            }
            
            console.log(`Deleted: ${deleted}, Errors: ${errors.length}`);
            
            if (errors.length > 0) {
                alert(`–£–¥–∞–ª–µ–Ω–æ: ${deleted}\n–û—à–∏–±–∫–∏: ${errors.join(', ')}`);
            }
            
            selectedIds.clear();
            if (selectMode) {
                toggleSelectMode();
            }
            
            // Force reload
            setTimeout(() => loadProducts(), 300);
        }
        
        async function loadStats() {
            document.getElementById('stats-content').innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            
            try {
                const res = await fetch(API + '/stats');
                const s = await res.json();
                
                document.getElementById('stats-content').innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${s.products}</div>
                            <div class="stat-label">–¢–æ–≤–∞—Ä–æ–≤</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${s.orders}</div>
                            <div class="stat-label">–ó–∞–∫–∞–∑–æ–≤</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${s.users}</div>
                            <div class="stat-label">–ö–ª–∏–µ–Ω—Ç–æ–≤</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${s.revenue}‚ÇΩ</div>
                            <div class="stat-label">–í—ã—Ä—É—á–∫–∞</div>
                        </div>
                    </div>`;
            } catch (e) {
                document.getElementById('stats-content').innerHTML = '<div class="loading">–û—à–∏–±–∫–∞</div>';
            }
        }
        
        function showTab(tab) {
            // Exit select mode when switching tabs
            if (selectMode) toggleSelectMode();
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[onclick="showTab('${tab}')"]`).classList.add('active');
            
            document.getElementById('tab-products').classList.toggle('hidden', tab !== 'products');
            document.getElementById('tab-stats').classList.toggle('hidden', tab !== 'stats');
            document.getElementById('product-form').classList.add('hidden');
            
            if (tab === 'stats') loadStats();
            if (tab === 'products') loadProducts();
        }
        
        function showForm(product = null) {
            if (selectMode) toggleSelectMode();
            
            editingId = product ? product.id : null;
            document.getElementById('form-title').textContent = product ? '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' : '‚ûï –ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä';
            
            document.getElementById('f-name').value = product ? product.name : '';
            document.getElementById('f-desc').value = product ? product.description : '';
            document.getElementById('f-price').value = product ? product.price : '';
            document.getElementById('f-stock').classList.toggle('on', product ? product.in_stock : true);
            
            // Reset photo
            photoData = null;
            document.getElementById('photo-preview').classList.add('hidden');
            document.getElementById('photo-placeholder').classList.remove('hidden');
            if (product && product.image_url) {
                document.getElementById('photo-preview').src = product.image_url;
                document.getElementById('photo-preview').classList.remove('hidden');
                document.getElementById('photo-placeholder').classList.add('hidden');
            }
            
            document.getElementById('tab-products').classList.add('hidden');
            document.getElementById('product-form').classList.remove('hidden');
            document.querySelector('.fab').classList.add('hidden');
            document.getElementById('bulk-bar').classList.remove('visible');
        }
        
        function hideForm() {
            document.getElementById('product-form').classList.add('hidden');
            document.getElementById('tab-products').classList.remove('hidden');
            document.querySelector('.fab').classList.remove('hidden');
        }
        
        async function editProduct(id) {
            try {
                const res = await fetch(API + '/products/' + id);
                const product = await res.json();
                showForm(product);
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–∞');
            }
        }
        
        async function deleteProduct(id, name) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å "${name}"?`)) return;
            
            try {
                await fetch(API + '/products/' + id, {
                    method: 'DELETE',
                    headers: { 'X-Auth-Token': TOKEN }
                });
                loadProducts();
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            }
        }
        
        function handlePhoto(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(ev) {
                photoData = ev.target.result;
                document.getElementById('photo-preview').src = photoData;
                document.getElementById('photo-preview').classList.remove('hidden');
                document.getElementById('photo-placeholder').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }
        
        async function saveProduct() {
            const name = document.getElementById('f-name').value.trim();
            const desc = document.getElementById('f-desc').value.trim();
            const price = parseInt(document.getElementById('f-price').value);
            const inStock = document.getElementById('f-stock').classList.contains('on');
            
            if (!name || !desc || !price) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            const data = {
                name,
                description: desc,
                price,
                in_stock: inStock,
                image_url: photoData || null
            };
            
            try {
                const url = editingId ? API + '/products/' + editingId : API + '/products';
                const method = editingId ? 'PUT' : 'POST';
                
                await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Auth-Token': TOKEN
                    },
                    body: JSON.stringify(data)
                });
                
                hideForm();
                loadProducts();
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        }
    </script>
</body>
</html>
