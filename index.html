<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>FlowerShop Admin</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --bg: #1c1c1e;
            --card: #2c2c2e;
            --text: #ffffff;
            --hint: #8e8e93;
            --accent: #3390ec;
            --green: #34c759;
            --red: #ff3b30;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        .header {
            background: var(--card);
            padding: 16px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 { font-size: 18px; font-weight: 600; }
        
        .tabs {
            display: flex;
            background: var(--card);
            padding: 8px;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .tab {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: var(--hint);
            font-size: 14px;
            cursor: pointer;
        }
        
        .tab.active {
            background: var(--accent);
            color: white;
        }
        
        .content { padding: 0 16px; }
        
        /* Products List */
        .product-card {
            background: var(--card);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .product-img {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--bg);
        }
        
        .product-info { flex: 1; }
        .product-name { font-weight: 600; margin-bottom: 4px; }
        .product-price { color: var(--green); font-weight: 500; }
        .product-status { font-size: 12px; color: var(--hint); }
        
        .product-actions { display: flex; gap: 8px; }
        .btn-icon {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        .btn-edit { background: var(--accent); color: white; }
        .btn-delete { background: var(--red); color: white; }
        
        /* Form */
        .form-group { margin-bottom: 16px; }
        .form-label {
            display: block;
            font-size: 13px;
            color: var(--hint);
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        .form-input {
            width: 100%;
            background: var(--card);
            border: none;
            border-radius: 12px;
            padding: 14px 16px;
            font-size: 16px;
            color: var(--text);
            outline: none;
        }
        .form-input:focus { box-shadow: 0 0 0 2px var(--accent); }
        textarea.form-input { min-height: 100px; resize: vertical; }
        
        .photo-upload {
            background: var(--card);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 16px;
        }
        .photo-upload img {
            max-width: 100%;
            max-height: 150px;
            border-radius: 8px;
        }
        .photo-icon { font-size: 40px; }
        .photo-text { color: var(--hint); font-size: 14px; margin-top: 8px; }
        
        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card);
            padding: 14px 16px;
            border-radius: 12px;
        }
        
        .toggle {
            width: 51px; height: 31px;
            background: #39393d;
            border-radius: 16px;
            position: relative;
            cursor: pointer;
        }
        .toggle.on { background: var(--green); }
        .toggle::after {
            content: '';
            position: absolute;
            width: 27px; height: 27px;
            background: white;
            border-radius: 50%;
            top: 2px; left: 2px;
            transition: 0.3s;
        }
        .toggle.on::after { left: 22px; }
        
        .btn-primary {
            width: 100%;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 16px;
        }
        .btn-primary:disabled { opacity: 0.5; }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .stat-card {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        .stat-value { font-size: 28px; font-weight: 700; }
        .stat-label { color: var(--hint); font-size: 13px; margin-top: 4px; }
        
        /* Add button */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: var(--accent);
            border: none;
            border-radius: 50%;
            font-size: 28px;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--hint);
        }
        
        .empty {
            text-align: center;
            padding: 40px;
            color: var(--hint);
        }
        .empty-icon { font-size: 48px; margin-bottom: 12px; }
        
        .hidden { display: none !important; }
        
        #fileInput { display: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üå∏ FlowerShop Admin</h1>
    </div>
    
    <div class="tabs">
        <button class="tab active" onclick="showTab('products')">üì¶ –¢–æ–≤–∞—Ä—ã</button>
        <button class="tab" onclick="showTab('stats')">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
    </div>
    
    <!-- Products Tab -->
    <div id="tab-products" class="content">
        <div id="products-list"></div>
        <button class="fab" onclick="showForm()">+</button>
    </div>
    
    <!-- Stats Tab -->
    <div id="tab-stats" class="content hidden">
        <div id="stats-content"></div>
    </div>
    
    <!-- Product Form -->
    <div id="product-form" class="content hidden">
        <div class="header" style="margin: -16px -16px 16px; position: static;">
            <h1 id="form-title">‚ûï –ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</h1>
        </div>
        
        <div class="photo-upload" onclick="document.getElementById('fileInput').click()">
            <div id="photo-placeholder">
                <div class="photo-icon">üì∑</div>
                <div class="photo-text">–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</div>
            </div>
            <img id="photo-preview" class="hidden">
        </div>
        <input type="file" id="fileInput" accept="image/*" onchange="handlePhoto(event)">
        
        <div class="form-group">
            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input type="text" class="form-input" id="f-name" placeholder="–ù–µ–∂–Ω–æ—Å—Ç—å">
        </div>
        
        <div class="form-group">
            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea class="form-input" id="f-desc" placeholder="–ë—É–∫–µ—Ç –∏–∑ 15 —Ä–æ–∑–æ–≤—ã—Ö —Ä–æ–∑..."></textarea>
        </div>
        
        <div class="form-group">
            <label class="form-label">–¶–µ–Ω–∞ (‚ÇΩ)</label>
            <input type="number" class="form-input" id="f-price" placeholder="2500">
        </div>
        
        <div class="form-group">
            <div class="toggle-row">
                <span>–í –Ω–∞–ª–∏—á–∏–∏</span>
                <div class="toggle on" id="f-stock" onclick="this.classList.toggle('on')"></div>
            </div>
        </div>
        
        <button class="btn-primary" onclick="saveProduct()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="btn-primary" style="background: var(--hint); margin-top: 8px;" onclick="hideForm()">–û—Ç–º–µ–Ω–∞</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();
        
        // Apply theme
        if (tg.themeParams) {
            document.body.style.setProperty('--bg', tg.themeParams.bg_color || '#1c1c1e');
            document.body.style.setProperty('--card', tg.themeParams.secondary_bg_color || '#2c2c2e');
            document.body.style.setProperty('--text', tg.themeParams.text_color || '#ffffff');
            document.body.style.setProperty('--hint', tg.themeParams.hint_color || '#8e8e93');
            document.body.style.setProperty('--accent', tg.themeParams.button_color || '#3390ec');
        }
        
        const API = 'https://drop-seo-firewire-thompson.trycloudflare.com';
        const TOKEN = 'flowershop_admin_2024';
        
        let editingId = null;
        let photoData = null;
        
        // Load products on start
        loadProducts();
        
        async function loadProducts() {
            document.getElementById('products-list').innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            
            try {
                const res = await fetch(API + '/products');
                const products = await res.json();
                
                if (products.length === 0) {
                    document.getElementById('products-list').innerHTML = `
                        <div class="empty">
                            <div class="empty-icon">üì¶</div>
                            <div>–¢–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>
                        </div>`;
                    return;
                }
                
                let html = '';
                for (const p of products) {
                    const status = p.in_stock ? '‚úÖ –í –Ω–∞–ª–∏—á–∏–∏' : '‚ùå –ù–µ—Ç';
                    const img = p.image_url || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%232c2c2e" width="100" height="100"/><text x="50" y="55" text-anchor="middle" fill="%238e8e93" font-size="30">üå∏</text></svg>';
                    html += `
                        <div class="product-card">
                            <img class="product-img" src="${img}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%232c2c2e%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%238e8e93%22 font-size=%2230%22>üå∏</text></svg>'">
                            <div class="product-info">
                                <div class="product-name">${p.name}</div>
                                <div class="product-price">${p.price} ‚ÇΩ</div>
                                <div class="product-status">${status}</div>
                            </div>
                            <div class="product-actions">
                                <button class="btn-icon btn-edit" onclick="editProduct(${p.id})">‚úèÔ∏è</button>
                                <button class="btn-icon btn-delete" onclick="deleteProduct(${p.id}, '${p.name}')">üóë</button>
                            </div>
                        </div>`;
                }
                document.getElementById('products-list').innerHTML = html;
            } catch (e) {
                document.getElementById('products-list').innerHTML = '<div class="loading">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }
        
        async function loadStats() {
            document.getElementById('stats-content').innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            
            try {
                const res = await fetch(API + '/stats');
                const s = await res.json();
                
                document.getElementById('stats-content').innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${s.products}</div>
                            <div class="stat-label">–¢–æ–≤–∞—Ä–æ–≤</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${s.orders}</div>
                            <div class="stat-label">–ó–∞–∫–∞–∑–æ–≤</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${s.users}</div>
                            <div class="stat-label">–ö–ª–∏–µ–Ω—Ç–æ–≤</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${s.revenue}‚ÇΩ</div>
                            <div class="stat-label">–í—ã—Ä—É—á–∫–∞</div>
                        </div>
                    </div>`;
            } catch (e) {
                document.getElementById('stats-content').innerHTML = '<div class="loading">–û—à–∏–±–∫–∞</div>';
            }
        }
        
        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[onclick="showTab('${tab}')"]`).classList.add('active');
            
            document.getElementById('tab-products').classList.toggle('hidden', tab !== 'products');
            document.getElementById('tab-stats').classList.toggle('hidden', tab !== 'stats');
            document.getElementById('product-form').classList.add('hidden');
            
            if (tab === 'stats') loadStats();
            if (tab === 'products') loadProducts();
        }
        
        function showForm(product = null) {
            editingId = product ? product.id : null;
            document.getElementById('form-title').textContent = product ? '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' : '‚ûï –ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä';
            
            document.getElementById('f-name').value = product ? product.name : '';
            document.getElementById('f-desc').value = product ? product.description : '';
            document.getElementById('f-price').value = product ? product.price : '';
            document.getElementById('f-stock').classList.toggle('on', product ? product.in_stock : true);
            
            // Reset photo
            photoData = null;
            document.getElementById('photo-preview').classList.add('hidden');
            document.getElementById('photo-placeholder').classList.remove('hidden');
            if (product && product.image_url) {
                document.getElementById('photo-preview').src = product.image_url;
                document.getElementById('photo-preview').classList.remove('hidden');
                document.getElementById('photo-placeholder').classList.add('hidden');
            }
            
            document.getElementById('tab-products').classList.add('hidden');
            document.getElementById('product-form').classList.remove('hidden');
            document.querySelector('.fab').classList.add('hidden');
        }
        
        function hideForm() {
            document.getElementById('product-form').classList.add('hidden');
            document.getElementById('tab-products').classList.remove('hidden');
            document.querySelector('.fab').classList.remove('hidden');
        }
        
        async function editProduct(id) {
            try {
                const res = await fetch(API + '/products/' + id);
                const product = await res.json();
                showForm(product);
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–∞');
            }
        }
        
        async function deleteProduct(id, name) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å "${name}"?`)) return;
            
            try {
                await fetch(API + '/products/' + id, {
                    method: 'DELETE',
                    headers: { 'X-Auth-Token': TOKEN }
                });
                loadProducts();
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            }
        }
        
        function handlePhoto(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(ev) {
                photoData = ev.target.result;
                document.getElementById('photo-preview').src = photoData;
                document.getElementById('photo-preview').classList.remove('hidden');
                document.getElementById('photo-placeholder').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }
        
        async function saveProduct() {
            const name = document.getElementById('f-name').value.trim();
            const desc = document.getElementById('f-desc').value.trim();
            const price = parseInt(document.getElementById('f-price').value);
            const inStock = document.getElementById('f-stock').classList.contains('on');
            
            if (!name || !desc || !price) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            const data = {
                name,
                description: desc,
                price,
                in_stock: inStock,
                image_url: photoData || null
            };
            
            try {
                const url = editingId ? API + '/products/' + editingId : API + '/products';
                const method = editingId ? 'PUT' : 'POST';
                
                await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Auth-Token': TOKEN
                    },
                    body: JSON.stringify(data)
                });
                
                hideForm();
                loadProducts();
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        }
    </script>
</body>
</html>
