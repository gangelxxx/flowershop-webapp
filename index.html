<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #1c1c1e;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #8e8e93;
            --tg-theme-button-color: #3390ec;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #2c2c2e;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            padding: 16px;
            padding-bottom: 100px;
            min-height: 100vh;
        }
        
        .header { text-align: center; margin-bottom: 24px; }
        .header h1 { font-size: 20px; font-weight: 600; margin-bottom: 4px; }
        .header p { color: var(--tg-theme-hint-color); font-size: 14px; }
        
        .photo-upload {
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
        }
        .photo-upload.has-photo { padding: 0; overflow: hidden; }
        .photo-upload img { width: 100%; max-height: 200px; object-fit: cover; border-radius: 16px; }
        .photo-icon { font-size: 48px; margin-bottom: 8px; }
        .photo-text { color: var(--tg-theme-hint-color); font-size: 14px; }
        
        .form-group { margin-bottom: 16px; }
        .form-label {
            display: block; font-size: 13px; color: var(--tg-theme-hint-color);
            margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .form-input {
            width: 100%; background: var(--tg-theme-secondary-bg-color);
            border: none; border-radius: 12px; padding: 14px 16px;
            font-size: 16px; color: var(--tg-theme-text-color); outline: none;
        }
        .form-input:focus { box-shadow: 0 0 0 2px var(--tg-theme-button-color); }
        .form-input::placeholder { color: var(--tg-theme-hint-color); }
        textarea.form-input { min-height: 100px; resize: vertical; }
        
        .price-input { position: relative; }
        .price-input .form-input { padding-right: 40px; }
        .price-input .currency {
            position: absolute; right: 16px; top: 50%; transform: translateY(-50%);
            color: var(--tg-theme-hint-color); font-size: 16px;
        }
        
        .toggle-group {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 12px; padding: 14px 16px;
        }
        .toggle-label { font-size: 16px; }
        .toggle {
            width: 51px; height: 31px; background: #39393d;
            border-radius: 16px; position: relative; cursor: pointer; transition: all 0.3s;
        }
        .toggle.active { background: #34c759; }
        .toggle::after {
            content: ''; position: absolute; width: 27px; height: 27px;
            background: white; border-radius: 50%; top: 2px; left: 2px;
            transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .toggle.active::after { left: 22px; }
        
        .hidden { display: none; }
        #fileInput { display: none; }
        
        .debug { 
            position: fixed; bottom: 60px; left: 10px; right: 10px;
            background: rgba(255,0,0,0.8); color: white; padding: 8px;
            border-radius: 8px; font-size: 12px; display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="title">‚ûï –ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</h1>
        <p id="subtitle">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±—É–∫–µ—Ç–µ</p>
    </div>
    
    <div class="photo-upload" id="photoUpload" onclick="document.getElementById('fileInput').click()">
        <div id="photoPlaceholder">
            <div class="photo-icon">üì∑</div>
            <div class="photo-text">–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</div>
        </div>
        <img id="photoPreview" class="hidden" alt="Preview">
    </div>
    <input type="file" id="fileInput" accept="image/*" onchange="handlePhotoSelect(event)">
    
    <div class="form-group">
        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <input type="text" class="form-input" id="name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–µ–∂–Ω–æ—Å—Ç—å">
    </div>
    
    <div class="form-group">
        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <textarea class="form-input" id="description" placeholder="–û–ø–∏—à–∏—Ç–µ –±—É–∫–µ—Ç..."></textarea>
    </div>
    
    <div class="form-group">
        <label class="form-label">–¶–µ–Ω–∞</label>
        <div class="price-input">
            <input type="number" class="form-input" id="price" placeholder="2500">
            <span class="currency">‚ÇΩ</span>
        </div>
    </div>
    
    <div class="form-group">
        <div class="toggle-group">
            <span class="toggle-label">–í –Ω–∞–ª–∏—á–∏–∏</span>
            <div class="toggle active" id="inStock" onclick="toggleStock()"></div>
        </div>
    </div>
    
    <div class="debug" id="debug"></div>

    <script>
        const tg = window.Telegram.WebApp;
        const debug = document.getElementById('debug');
        
        function log(msg) {
            console.log(msg);
            debug.style.display = 'block';
            debug.textContent = msg;
        }
        
        tg.expand();
        tg.ready();
        
        // Apply Telegram theme
        if (tg.themeParams) {
            document.body.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#1c1c1e');
            document.body.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#ffffff');
            document.body.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#8e8e93');
            document.body.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#3390ec');
            document.body.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#2c2c2e');
        }
        
        let photoData = null;
        let inStock = true;
        
        // Main button setup
        tg.MainButton.setText('–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä');
        tg.MainButton.show();
        
        // Use onEvent instead of onClick (more reliable)
        tg.onEvent('mainButtonClicked', function() {
            log('Button clicked!');
            submitForm();
        });
        
        function toggleStock() {
            inStock = !inStock;
            document.getElementById('inStock').classList.toggle('active', inStock);
        }
        
        function handlePhotoSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                photoData = e.target.result;
                document.getElementById('photoPreview').src = photoData;
                document.getElementById('photoPreview').classList.remove('hidden');
                document.getElementById('photoPlaceholder').classList.add('hidden');
                document.getElementById('photoUpload').classList.add('has-photo');
            };
            reader.readAsDataURL(file);
        }
        
        function submitForm() {
            const name = document.getElementById('name').value.trim();
            const description = document.getElementById('description').value.trim();
            const price = document.getElementById('price').value;
            
            log('Validating: ' + name + ', ' + description + ', ' + price);
            
            if (!name) {
                tg.showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞');
                return;
            }
            if (!description) {
                tg.showAlert('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ');
                return;
            }
            if (!price || price <= 0) {
                tg.showAlert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É');
                return;
            }
            
            const data = {
                action: 'add',
                name: name,
                description: description,
                price: parseInt(price),
                in_stock: inStock,
                has_photo: !!photoData
            };
            
            log('Sending: ' + JSON.stringify(data));
            
            try {
                tg.sendData(JSON.stringify(data));
                log('Data sent!');
            } catch (e) {
                log('Error: ' + e.message);
                tg.showAlert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }
        
        // Validate on input
        ['name', 'description', 'price'].forEach(id => {
            document.getElementById(id).addEventListener('input', function() {
                const name = document.getElementById('name').value.trim();
                const description = document.getElementById('description').value.trim();
                const price = document.getElementById('price').value;
                
                if (name && description && price > 0) {
                    tg.MainButton.enable();
                } else {
                    tg.MainButton.disable();
                }
            });
        });
    </script>
</body>
</html>
