<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–í—ã–±–µ—Ä–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        #map { width: 100%; height: calc(100vh - 120px); }
        .info-panel {
            padding: 12px 16px;
            background: var(--tg-theme-bg-color, #fff);
            border-top: 1px solid var(--tg-theme-hint-color, #ccc);
        }
        .address {
            font-size: 14px;
            color: var(--tg-theme-text-color, #000);
            min-height: 40px;
            margin-bottom: 8px;
        }
        .hint {
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999);
            margin-bottom: 8px;
        }
        .btn {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #fff);
            cursor: pointer;
        }
        .btn:disabled {
            opacity: 0.5;
        }
        .center-marker {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -100%);
            z-index: 1000;
            font-size: 40px;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="center-marker">üìç</div>
    <div class="info-panel">
        <div class="hint">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç–µ –∫–∞—Ä—Ç—É —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É –¥–æ—Å—Ç–∞–≤–∫–∏</div>
        <div class="address" id="address">–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞...</div>
        <button class="btn" id="confirmBtn" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∞–¥—Ä–µ—Å</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        // Default: Moscow center
        let lat = 55.7558;
        let lon = 37.6173;
        let currentAddress = '';

        // Try to get user location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    lat = pos.coords.latitude;
                    lon = pos.coords.longitude;
                    map.setView([lat, lon], 16);
                    updateAddress();
                },
                () => {
                    // Use default location
                    updateAddress();
                }
            );
        }

        // Initialize map
        const map = L.map('map').setView([lat, lon], 15);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        // Update address on map move
        let debounceTimer;
        map.on('moveend', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(updateAddress, 500);
        });

        async function updateAddress() {
            const center = map.getCenter();
            lat = center.lat;
            lon = center.lng;
            
            document.getElementById('address').textContent = '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞...';
            document.getElementById('confirmBtn').disabled = true;

            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=ru`,
                    { headers: { 'User-Agent': 'FlowerBot/1.0' } }
                );
                const data = await response.json();
                
                if (data.display_name) {
                    currentAddress = data.display_name;
                    // Shorten address
                    const parts = currentAddress.split(', ');
                    const short = parts.slice(0, 4).join(', ');
                    document.getElementById('address').textContent = short;
                    document.getElementById('confirmBtn').disabled = false;
                }
            } catch (e) {
                currentAddress = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                document.getElementById('address').textContent = currentAddress;
                document.getElementById('confirmBtn').disabled = false;
            }
        }

        // Confirm button
        document.getElementById('confirmBtn').addEventListener('click', () => {
            const data = {
                address: currentAddress,
                lat: lat,
                lon: lon
            };
            tg.sendData(JSON.stringify(data));
        });

        // Initial address lookup
        updateAddress();
    </script>
</body>
</html>
